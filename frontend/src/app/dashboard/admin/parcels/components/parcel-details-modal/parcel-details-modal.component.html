<!-- src/app/admin/pages/parcels/components/parcel-details-modal/parcel-details-modal.component.html -->
<div *ngIf="show" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">

    <!-- Background overlay -->
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-75 transition-opacity"
            (click)="onClose()">
        </div>

        <!-- Modal positioning -->
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <!-- Modal panel -->
        <div
            class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">

            <!-- Header -->
            <div class="bg-white dark:bg-gray-800 px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="modal-title">
                                Parcel Details
                            </h3>
                            <div class="flex items-center space-x-4 mt-1">
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400">
                                    {{ parcel?.trackingNumber }}
                                </span>
                                <button type="button" (click)="copyToClipboard(parcel?.trackingNumber || '')"
                                    class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                    <lucide-icon name="copy" class="h-4 w-4"></lucide-icon>
                                </button>
                            </div>
                        </div>
                        <div *ngIf="parcel" class="flex items-center">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                [class]="getStatusConfig(parcel.status).color">
                                <lucide-icon [name]="getStatusConfig(parcel.status).icon" class="h-4 w-4 mr-2">
                                </lucide-icon>
                                {{ getStatusConfig(parcel.status).label }}
                            </span>
                        </div>
                    </div>
                    <button type="button" (click)="onClose()"
                        class="bg-white dark:bg-gray-800 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <lucide-icon name="x" class="h-6 w-6"></lucide-icon>
                    </button>
                </div>

                <!-- Tabs -->
                <div class="mt-4">
                    <nav class="flex space-x-8" aria-label="Tabs">
                        <button *ngFor="let tab of tabs" type="button" (click)="setActiveTab(tab.id)"
                            [class.border-blue-500]="activeTab === tab.id" [class.text-blue-600]="activeTab === tab.id"
                            [class.dark:text-blue-400]="activeTab === tab.id"
                            [class.border-transparent]="activeTab !== tab.id"
                            [class.text-gray-500]="activeTab !== tab.id"
                            [class.dark:text-gray-400]="activeTab !== tab.id"
                            class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm hover:text-gray-700 dark:hover:text-gray-300 focus:outline-none">
                            <div class="flex items-center">
                                <lucide-icon [name]="tab.icon" class="h-4 w-4 mr-2">
                                </lucide-icon>
                                {{ tab.label }}
                            </div>
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Content -->
            <div class="bg-white dark:bg-gray-800 px-6 py-6 max-h-[70vh] overflow-y-auto">
                <!-- Loading State -->
                <div *ngIf="loading" class="flex items-center justify-center py-12">
                    <lucide-icon name="loader-2" class="h-8 w-8 animate-spin text-gray-400 mr-3">
                    </lucide-icon>
                    <span class="text-gray-500 dark:text-gray-400">Loading parcel details...</span>
                </div>

                <!-- Details Tab -->
                <div *ngIf="!loading && activeTab === 'details' && parcelDetails" class="space-y-6">
                    <!-- Quick Info Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <lucide-icon name="package" class="h-8 w-8 text-blue-600 dark:text-blue-400">
                                    </lucide-icon>
                                </div>
                                <div class="ml-4">
                                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">Total Value</h4>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">
                                        {{ formatCurrency(parcelDetails.totalPrice, parcelDetails.currency) }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <lucide-icon name="weight" class="h-8 w-8 text-green-600 dark:text-green-400">
                                    </lucide-icon>
                                </div>
                                <div class="ml-4">
                                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">Weight</h4>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">
                                        {{ parcelDetails.weight }}{{ parcelDetails.weightUnit }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <lucide-icon name="calendar" class="h-8 w-8 text-purple-600 dark:text-purple-400">
                                    </lucide-icon>
                                </div>
                                <div class="ml-4">
                                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">Created</h4>
                                    <p class="text-lg font-semibold text-gray-900 dark:text-white">
                                        {{ formatDate(parcelDetails.createdAt) }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sender & Recipient Info -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Sender -->
                        <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-6">
                            <div class="flex items-center mb-4">
                                <lucide-icon name="user-check" class="h-5 w-5 text-gray-400 mr-2">
                                </lucide-icon>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Sender</h4>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-500 dark:text-gray-400">Name</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">{{ parcelDetails.sender.name
                                        }}</p>
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-500 dark:text-gray-400">Email</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">{{ parcelDetails.sender.email
                                        }}</p>
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-500 dark:text-gray-400">Phone</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">{{ parcelDetails.sender.phone
                                        }}</p>
                                </div>
                                <div *ngIf="parcelDetails.senderAddress">
                                    <label
                                        class="block text-sm font-medium text-gray-500 dark:text-gray-400">Address</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">
                                        {{ parcelDetails.senderAddress.street }}<br>
                                        {{ parcelDetails.senderAddress.area }}, {{ parcelDetails.senderAddress.city
                                        }}<br>
                                        {{ parcelDetails.senderAddress.county }}, {{ parcelDetails.senderAddress.country
                                        }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Recipient -->
                        <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-6">
                            <div class="flex items-center mb-4">
                                <lucide-icon name="user-x" class="h-5 w-5 text-gray-400 mr-2">
                                </lucide-icon>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Recipient</h4>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-500 dark:text-gray-400">Name</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">{{
                                        parcelDetails.recipient.name }}</p>
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-500 dark:text-gray-400">Email</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">{{
                                        parcelDetails.recipient.email }}</p>
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-500 dark:text-gray-400">Phone</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">{{
                                        parcelDetails.recipient.phone }}</p>
                                </div>
                                <div *ngIf="parcelDetails.recipientAddress">
                                    <label
                                        class="block text-sm font-medium text-gray-500 dark:text-gray-400">Address</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">
                                        {{ parcelDetails.recipientAddress.street }}<br>
                                        {{ parcelDetails.recipientAddress.area }}, {{
                                        parcelDetails.recipientAddress.city }}<br>
                                        {{ parcelDetails.recipientAddress.county }}, {{
                                        parcelDetails.recipientAddress.country }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Package Information -->
                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <lucide-icon name="box" class="h-5 w-5 text-gray-400 mr-2">
                            </lucide-icon>
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white">Package Information</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Package
                                    Type</label>
                                <p class="mt-1 text-sm text-gray-900 dark:text-white">{{ parcelDetails.packageType |
                                    titlecase }}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Delivery
                                    Type</label>
                                <p class="mt-1 text-sm text-gray-900 dark:text-white">{{ parcelDetails.deliveryType |
                                    titlecase }}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Estimated
                                    Delivery</label>
                                <p class="mt-1 text-sm text-gray-900 dark:text-white">
                                    {{ formatDate(parcelDetails.estimatedDelivery) }}
                                </p>
                            </div>
                            <div *ngIf="parcelDetails.actualDelivery">
                                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Actual
                                    Delivery</label>
                                <p class="mt-1 text-sm text-gray-900 dark:text-white">
                                    {{ formatDateTime(parcelDetails.actualDelivery) }}
                                </p>
                            </div>
                        </div>
                        <div *ngIf="parcelDetails.dimensions" class="mt-4">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Dimensions</label>
                            <p class="mt-1 text-sm text-gray-900 dark:text-white">
                                {{ parcelDetails.dimensions.length }} ×
                                {{ parcelDetails.dimensions.width }} ×
                                {{ parcelDetails.dimensions.height }}
                                {{ parcelDetails.dimensions.unit }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tracking History Tab -->
                <div *ngIf="!loading && activeTab === 'tracking' && parcelDetails?.trackingHistory" class="space-y-4">
                    <div *ngIf="parcelDetails.trackingHistory.length === 0" class="text-center py-8">
                        <lucide-icon name="map-pin-off" class="h-12 w-12 text-gray-400 mx-auto mb-4">
                        </lucide-icon>
                        <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-1">No tracking history</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            Tracking updates will appear here as the parcel moves.
                        </p>
                    </div>

                    <div *ngIf="parcelDetails.trackingHistory.length > 0" class="flow-root">
                        <ul class="-mb-8">
                            <li *ngFor="let history of parcelDetails.trackingHistory; let isLast = last">
                                <div class="relative pb-8">
                                    <span *ngIf="!isLast"
                                        class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200 dark:bg-gray-600"
                                        aria-hidden="true">
                                    </span>
                                    <div class="relative flex space-x-3">
                                        <div>
                                            <span
                                                class="h-8 w-8 rounded-full flex items-center justify-center ring-8 ring-white dark:ring-gray-800"
                                                [class]="getStatusConfig(history.status).color">
                                                <lucide-icon [name]="getTrackingIcon(history.status)" class="h-4 w-4">
                                                </lucide-icon>
                                            </span>
                                        </div>
                                        <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                                            <div>
                                                <p class="text-sm text-gray-900 dark:text-white font-medium">
                                                    {{ getStatusConfig(history.status).label }}
                                                </p>
                                                <p *ngIf="history.description"
                                                    class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                                    {{ history.description }}
                                                </p>
                                                <p *ngIf="history.location"
                                                    class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex items-center">
                                                    <lucide-icon name="map-pin" class="h-3 w-3 mr-1"></lucide-icon>
                                                    {{ history.location }}
                                                </p>
                                            </div>
                                            <div
                                                class="text-right text-sm whitespace-nowrap text-gray-500 dark:text-gray-400">
                                                <time [dateTime]="history.timestamp">
                                                    {{ formatDateTime(history.timestamp) }}
                                                </time>
                                                <p *ngIf="history.updatedBy" class="text-xs mt-1">
                                                    by {{ history.updatedBy }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Delivery Attempts Tab -->
                <div *ngIf="!loading && activeTab === 'delivery' && parcelDetails?.deliveryAttempts" class="space-y-4">
                    <div *ngIf="parcelDetails.deliveryAttempts.length === 0" class="text-center py-8">
                        <lucide-icon name="truck-off" class="h-12 w-12 text-gray-400 mx-auto mb-4">
                        </lucide-icon>
                        <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-1">No delivery attempts</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            Delivery attempts will be logged here.
                        </p>
                    </div>

                    <div *ngIf="parcelDetails.deliveryAttempts.length > 0" class="space-y-4">
                        <div *ngFor="let attempt of parcelDetails.deliveryAttempts"
                            class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="font-medium"
                                            [class]="getDeliveryAttemptStatusColor(attempt.status)">
                                            {{ attempt.status | titlecase }}
                                        </span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">
                                            {{ formatDateTime(attempt.attemptDate) }}
                                        </span>
                                    </div>
                                    <p *ngIf="attempt.reason" class="text-sm text-gray-600 dark:text-gray-300 mt-2">
                                        <strong>Reason:</strong> {{ attempt.reason }}
                                    </p>
                                    <p *ngIf="attempt.courierNotes"
                                        class="text-sm text-gray-600 dark:text-gray-300 mt-1">
                                        <strong>Notes:</strong> {{ attempt.courierNotes }}
                                    </p>
                                    <p *ngIf="attempt.nextAttempt"
                                        class="text-sm text-gray-600 dark:text-gray-300 mt-1">
                                        <strong>Next Attempt:</strong> {{ formatDateTime(attempt.nextAttempt) }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>