<!-- src/app/dashboard/courier/deliveries/components/delivery-details/delivery-details.component.html -->

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
        <div class="px-4 py-4">
            <div class="flex items-center space-x-4">
                <button (click)="goBack()"
                    class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <lucide-icon name="arrow-left" class="w-5 h-5"></lucide-icon>
                </button>

                <div class="flex-1">
                    <h1 class="text-xl font-semibold text-gray-900 dark:text-white">
                        Delivery Details
                    </h1>
                    <p *ngIf="delivery" class="text-sm text-gray-500 dark:text-gray-400">
                        {{ delivery.trackingNumber }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="flex items-center justify-center py-12">
        <p class="text-gray-500 dark:text-gray-400">Loading delivery details...</p>
        <lucide-icon name="loader" class="w-6 h-6 animate-spin text-blue-600 dark:text-blue-400 ml-2"></lucide-icon>
    </div>

    <!-- Delivery Details -->
    <div *ngIf="!loading && delivery" class="px-4 py-4 space-y-4">

        <!-- Status Card -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white">Current Status</h2>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                        [class]="getStatusColor(delivery.status)">
                        {{ delivery.status | titlecase }}
                    </span>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <lucide-icon name="clock" class="w-6 h-6 text-gray-400 mx-auto mb-2"></lucide-icon>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Estimated Delivery</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            {{ delivery.estimatedDelivery | date:'medium' }}
                        </p>
                    </div>

                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <lucide-icon name="dollar-sign" class="w-6 h-6 text-green-500 mx-auto mb-2"></lucide-icon>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Estimated Earnings</p>
                        <p class="text-xs text-green-600 dark:text-green-400 font-medium">
                            {{ formatCurrency(delivery.estimatedEarnings || 0) }}
                        </p>
                    </div>

                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <lucide-icon name="map-pin" class="w-6 h-6 text-blue-500 mx-auto mb-2"></lucide-icon>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Distance</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            {{ delivery.distance | number:'1.1-1' }}km
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Package Information -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4">
                <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Package Information</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="flex items-start space-x-3">
                            <lucide-icon [name]="getPackageTypeIcon(delivery.packageType)"
                                class="w-5 h-5 text-gray-400 mt-0.5"></lucide-icon>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">Package Type</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{{ delivery.packageType | titlecase
                                    }}</p>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <lucide-icon name="scale" class="w-5 h-5 text-gray-400 mt-0.5"></lucide-icon>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">Weight</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    {{ formatWeight(delivery.weight, delivery.weightUnit) }}
                                </p>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <lucide-icon name="dollar-sign" class="w-5 h-5 text-gray-400 mt-0.5"></lucide-icon>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">Declared Value</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    {{ formatCurrency(delivery.estimatedValue || 0) }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-start space-x-3">
                            <lucide-icon name="truck" class="w-5 h-5 text-gray-400 mt-0.5"></lucide-icon>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">Delivery Type</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{{ delivery.deliveryType | titlecase
                                    }}</p>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <lucide-icon name="flag" class="w-5 h-5 text-gray-400 mt-0.5"></lucide-icon>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">Priority</p>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                    [class]="getPriorityColor(delivery.priority)">
                                    {{ delivery.priority }}
                                </span>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <lucide-icon name="file-text" class="w-5 h-5 text-gray-400 mt-0.5"></lucide-icon>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">Description</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{{ delivery.description }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Special Handling Requirements -->
                <div *ngIf="delivery.fragile || delivery.perishable || delivery.highValue || delivery.signatureRequired"
                    class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                    <p class="text-sm font-medium text-gray-900 dark:text-white mb-2">Special Requirements</p>
                    <div class="flex flex-wrap gap-2">
                        <span *ngIf="delivery.fragile"
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400">
                            <lucide-icon name="alert-triangle" class="w-3 h-3 mr-1"></lucide-icon>
                            Fragile
                        </span>
                        <span *ngIf="delivery.perishable"
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-400">
                            <lucide-icon name="clock" class="w-3 h-3 mr-1"></lucide-icon>
                            Perishable
                        </span>
                        <span *ngIf="delivery.highValue"
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400">
                            <lucide-icon name="shield" class="w-3 h-3 mr-1"></lucide-icon>
                            High Value
                        </span>
                        <span *ngIf="delivery.signatureRequired"
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
                            <lucide-icon name="edit" class="w-3 h-3 mr-1"></lucide-icon>
                            Signature Required
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sender & Recipient Information -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Sender Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="px-6 py-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Sender</h3>

                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <lucide-icon name="user" class="w-4 h-4 text-gray-400"></lucide-icon>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ delivery.sender.name }}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ delivery.sender.email }}</p>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <lucide-icon name="phone" class="w-4 h-4 text-gray-400 mt-0.5"></lucide-icon>
                            <div class="flex-1">
                                <p class="text-sm text-gray-900 dark:text-white">{{ delivery.sender.phone }}</p>
                                <button (click)="onCallSender()"
                                    class="text-xs text-blue-600 dark:text-blue-400 hover:underline">
                                    Call Sender
                                </button>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <lucide-icon name="map-pin" class="w-4 h-4 text-gray-400 mt-0.5"></lucide-icon>
                            <div>
                                <p class="text-sm text-gray-900 dark:text-white">{{ delivery.senderAddress.street }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    {{ delivery.senderAddress.area }}, {{ delivery.senderAddress.city }}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    {{ delivery.senderAddress.county }}, {{ delivery.senderAddress.zipCode }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Pickup Instructions -->
                    <div *ngIf="delivery.pickupInstructions"
                        class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">Pickup Instructions</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ delivery.pickupInstructions }}</p>
                    </div>
                </div>
            </div>

            <!-- Recipient Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="px-6 py-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Recipient</h3>

                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <lucide-icon name="user" class="w-4 h-4 text-gray-400"></lucide-icon>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ delivery.recipient.name
                                    }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ delivery.recipient.email }}</p>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <lucide-icon name="phone" class="w-4 h-4 text-gray-400 mt-0.5"></lucide-icon>
                            <div class="flex-1">
                                <p class="text-sm text-gray-900 dark:text-white">{{ delivery.recipient.phone }}</p>
                                <button (click)="onCallRecipient()"
                                    class="text-xs text-blue-600 dark:text-blue-400 hover:underline">
                                    Call Recipient
                                </button>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <lucide-icon name="map-pin" class="w-4 h-4 text-gray-400 mt-0.5"></lucide-icon>
                            <div class="flex-1">
                                <p class="text-sm text-gray-900 dark:text-white">{{ delivery.recipientAddress.street }}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    {{ delivery.recipientAddress.area }}, {{ delivery.recipientAddress.city }}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    {{ delivery.recipientAddress.county }}, {{ delivery.recipientAddress.zipCode }}
                                </p>
                                <button (click)="onNavigateToAddress()"
                                    class="mt-1 text-xs text-blue-600 dark:text-blue-400 hover:underline">
                                    Get Directions
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Instructions -->
                    <div *ngIf="delivery.deliveryInstructions"
                        class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">Delivery Instructions</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ delivery.deliveryInstructions }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tracking History -->
        <div *ngIf="delivery.trackingHistory && delivery.trackingHistory.length > 0"
            class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Tracking History</h3>

                <div class="space-y-4">
                    <div *ngFor="let track of delivery.trackingHistory"
                        class="flex items-start space-x-3 pb-4 border-b border-gray-200 dark:border-gray-600 last:border-b-0 last:pb-0">
                        <div class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-900 dark:text-white">
                                    {{ track.status | titlecase }}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    {{ track.timestamp | date:'medium' }}
                                </p>
                            </div>
                            <p *ngIf="track.description" class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                {{ track.description }}
                            </p>
                            <p *ngIf="track.location" class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                {{ track.location }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Actions</h3>

                <div class="flex flex-wrap gap-3">
                    <!-- Update Status -->
                    <button *ngIf="canUpdateStatus()" (click)="openStatusModal()"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                        <lucide-icon name="refresh-cw" class="w-4 h-4 mr-2"></lucide-icon>
                        Update Status
                    </button>

                    <!-- Mark as Delivered (with photo) -->
                    <button *ngIf="isDeliveryStatus()" (click)="openPhotoModal()"
                        class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
                        <lucide-icon name="camera" class="w-4 h-4 mr-2"></lucide-icon>
                        Complete Delivery
                    </button>

                    <!-- Navigation -->
                    <button (click)="onNavigateToAddress()"
                        class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
                        <lucide-icon name="navigation" class="w-4 h-4 mr-2"></lucide-icon>
                        Navigate
                    </button>

                    <!-- Call Recipient -->
                    <button (click)="onCallRecipient()"
                        class="inline-flex items-center px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg transition-colors">
                        <lucide-icon name="phone" class="w-4 h-4 mr-2"></lucide-icon>
                        Call Recipient
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<app-modal *ngIf="showStatusModal" (close)="closeStatusModal()">
    <div class="p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Update Delivery Status</h3>

        <form [formGroup]="statusUpdateForm" (ngSubmit)="onStatusUpdate()">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        New Status
                    </label>
                    <select formControlName="status"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                        <option value="PICKED_UP">Picked Up</option>
                        <option value="IN_TRANSIT">In Transit</option>
                        <option value="OUT_FOR_DELIVERY">Out for Delivery</option>
                        <option value="DELIVERED">Delivered</option>
                        <option value="DELAYED">Delayed</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Notes (Optional)
                    </label>
                    <textarea formControlName="notes" rows="3" placeholder="Add any additional notes..."
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Current Location
                    </label>
                    <input formControlName="location" type="text" readonly
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-white" />
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" (click)="closeStatusModal()"
                    class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-lg transition-colors">
                    Cancel
                </button>
                <button type="submit" [disabled]="!statusUpdateForm.valid"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors">
                    Update Status
                </button>
            </div>
        </form>
    </div>
</app-modal>

<!-- Photo Capture Modal -->
<app-modal *ngIf="showPhotoModal" (close)="closePhotoModal()">
    <div class="p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Complete Delivery</h3>

        <div class="space-y-4">
            <!-- Photo Capture Component -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Delivery Proof Photo *
                </label>
                <app-photo-capture (photoCapture)="onPhotoCapture($event)" [required]="true"></app-photo-capture>
            </div>

            <!-- Photo Preview -->
            <div *ngIf="photoPreview" class="mt-4">
                <img [src]="photoPreview" alt="Delivery proof" class="w-full h-48 object-cover rounded-lg">
            </div>

            <!-- Delivery Notes -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Delivery Notes (Optional)
                </label>
                <textarea formControlName="notes" rows="3" placeholder="Add any delivery notes..."
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
        </div>

        <div class="flex justify-end space-x-3 mt-6">
            <button type="button" (click)="closePhotoModal()"
                class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-lg transition-colors">
                Cancel
            </button>
            <button (click)="onMarkAsDelivered()" [disabled]="!capturedPhoto"
                class="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-colors">
                <lucide-icon name="check-circle" class="w-4 h-4 mr-2"></lucide-icon>
                Mark as Delivered
            </button>
        </div>
    </div>
</app-modal>